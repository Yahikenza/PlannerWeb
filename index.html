<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planner quotidien ‚Äî Kenza</title>
  <style>
    body {font-family: Arial, Helvetica, sans-serif; margin:16px; max-width:900px;}
    header {display:flex; align-items:center; gap:12px; margin-bottom:12px;}
    h1 {margin:0; font-size:1.2rem;}
    .controls {display:flex; gap:8px; align-items:center;}
    input[type="text"]{padding:8px; width:380px; border:1px solid #ccc; border-radius:4px;}
    button{padding:8px 10px; border-radius:4px; border:1px solid #888; background:#f4f4f4; cursor:pointer;}
    .tasks {margin-top:12px;}
    .task {display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee;}
    .task .left {display:flex; gap:10px; align-items:center;}
    .status {padding:4px 8px; border-radius:12px; font-size:0.85rem;}
    .status.todo {background:#ffecec; color:#b00;}
    .status.doing {background:#fff4db; color:#b45f00;}
    .status.done {background:#e8f7e8; color:#0a7a0a;}
    .date-row {margin-top:8px; display:flex; gap:8px; align-items:center;}
    .small {font-size:0.9rem; color:#555;}
    .btn-ic {border:none; background:transparent; cursor:pointer; padding:6px;}
    .history-list {margin-top:12px;}
    .muted {color:#666; font-size:0.9rem;}
    @media (max-width:640px){ input[type="text"]{width:180px;} }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Planner quotidien</h1>
      <div class="small muted">Agis aujourd‚Äôhui ‚Äî r√©colte demain</div>
    </div>
    <div style="margin-left:auto" class="controls">
      <label for="date">Date</label>
      <input id="date" type="date" />
    </div>
  </header>

  <div>
    <div class="date-row">
      <input id="newtask" type="text" placeholder="Nouvelle t√¢che..." />
      <button id="add">Ajouter</button>
      <button id="clearDone" title="Supprimer toutes les t√¢ches termin√©es">Supprimer termin√©es</button>
      <button id="exportCsv" title="Exporter l'historique en CSV">Exporter CSV</button>
    </div>

    <div class="tasks" id="tasksContainer"></div>

    <div class="history-list">
      <h3 style="margin-bottom:6px">Historique (dates enregistr√©es)</h3>
      <div id="history"></div>
    </div>
  </div>

<script>
const PREFIX = 'planner:';
const STATUSES = ["√Ä faire","En cours","Termin√©"];
const COPY_LOOKBACK_DAYS = 30;

function iso(d){ return d.toISOString().slice(0,10); }
function todayIso(){ return iso(new Date()); }
function storageKey(dateIso){ return PREFIX + dateIso; }
function uid(){ return Math.random().toString(36).slice(2,9); }

function loadTasks(dateIso){
  const raw = localStorage.getItem(storageKey(dateIso));
  if(!raw) return [];
  try{ return JSON.parse(raw); }catch(e){ return []; }
}
function saveTasks(dateIso,tasks){ localStorage.setItem(storageKey(dateIso),JSON.stringify(tasks)); }
function listStoredDates(){
  const dates=[];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k && k.startsWith(PREFIX)) dates.push(k.slice(PREFIX.length));
  }
  return dates.sort((a,b)=>b.localeCompare(a));
}

function copyUnfinishedFromLast(dateIso){
  if(localStorage.getItem(storageKey(dateIso))) return 0;
  const target = new Date(dateIso);
  for(let d=1;d<=COPY_LOOKBACK_DAYS;d++){
    const prev = new Date(target); prev.setDate(prev.getDate()-d);
    const prevIso = iso(prev);
    const prevTasks = loadTasks(prevIso);
    if(prevTasks.length){
      const toCopy = prevTasks.filter(t=>t.status!=="Termin√©").map(t=>({
        id: uid(), text:t.text, status:t.status,
        created_at:t.created_at||new Date().toISOString(),
        updated_at:new Date().toISOString()
      }));
      if(toCopy.length){ saveTasks(dateIso,toCopy); return toCopy.length; } else return 0;
    }
  }
  return 0;
}

const dateInput = document.getElementById('date');
const newTaskInput = document.getElementById('newtask');
const tasksContainer = document.getElementById('tasksContainer');
const historyDiv = document.getElementById('history');

function persistAndRender(dateIso, tasks){ saveTasks(dateIso,tasks); render(dateIso); }

function addTask(dateIso, text){
  if(!text || !text.trim()) return;
  const tasks=loadTasks(dateIso);
  const t={id:uid(), text:text.trim(), status:STATUSES[0], created_at:new Date().toISOString(), updated_at:new Date().toISOString()};
  tasks.push(t); persistAndRender(dateIso,tasks);
}
function toggleStatus(dateIso,id){
  const tasks=loadTasks(dateIso);
  const t=tasks.find(x=>x.id===id); if(!t) return;
  const i=STATUSES.indexOf(t.status); t.status=STATUSES[(i+1)%STATUSES.length];
  t.updated_at=new Date().toISOString(); persistAndRender(dateIso,tasks);
}
function deleteTask(dateIso,id){
  let tasks=loadTasks(dateIso); tasks=tasks.filter(x=>x.id!==id); persistAndRender(dateIso,tasks);
}
function clearDone(dateIso){ let tasks=loadTasks(dateIso); tasks=tasks.filter(x=>x.status!=="Termin√©"); persistAndRender(dateIso,tasks); }

function exportAllToCSV(){
  try{
    const dates=listStoredDates();
    let csv="date,id,text,status,created_at,updated_at\n";
    dates.forEach(d=>{
      const tasks=loadTasks(d);
      tasks.forEach(t=>{ csv+=`${d},${t.id},"${t.text.replace(/"/g,'""')}",${t.status},${t.created_at},${t.updated_at}\n`; });
    });
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='planner.csv'; a.click(); URL.revokeObjectURL(url);
  }catch(e){ alert("Impossible d'exporter CSV : "+e); }
}

function render(dateIso){
  const tasks=loadTasks(dateIso);
  tasksContainer.innerHTML='';
  if(!tasks.length){ tasksContainer.innerHTML='<div class="muted">Aucune t√¢che pour cette date.</div>'; }
  else{
    tasks.forEach(t=>{
      const el=document.createElement('div'); el.className='task';
      const left=document.createElement('div'); left.className='left';
      const text=document.createElement('div'); text.textContent=t.text; text.style.maxWidth='620px';
      const status=document.createElement('div'); status.className='status ' + (t.status==='√Ä faire'?'todo':t.status==='En cours'?'doing':'done'); status.textContent=t.status;
      left.appendChild(text); el.appendChild(left);
      const right=document.createElement('div');
      const btnToggle=document.createElement('button'); btnToggle.className='btn-ic'; btnToggle.title='Changer le statut'; btnToggle.innerHTML='üîÅ';
      btnToggle.onclick=()=>{toggleStatus(dateIso,t.id);};
      const btnDel=document.createElement('button'); btnDel.className='btn-ic'; btnDel.title='Supprimer'; btnDel.innerHTML='üóëÔ∏è';
      btnDel.onclick=()=>{deleteTask(dateIso,t.id);};
      right.appendChild(status); right.appendChild(btnToggle); right.appendChild(btnDel);
      el.appendChild(right); tasksContainer.appendChild(el);

      text.onclick=()=>{
        const input=document.createElement('input'); input.type='text'; input.value=t.text; input.style.width='420px';
        text.replaceWith(input); input.focus();
        input.onblur=()=>{ t.text=input.value||t.text; t.updated_at=new Date().toISOString(); persistAndRender(dateIso,tasks); };
        input.onkeydown=(e)=>{ if(e.key==='Enter') input.blur(); };
      };
    });
  }

  // historique
  const dates=listStoredDates();
  historyDiv.innerHTML='';
  if(!dates.length){ historyDiv.innerHTML='<div class="muted">Aucun historique.</div>'; return; }
  dates.forEach(d=>{ const btn=document.createElement('button'); btn.textContent=d; btn.style.marginRight='6px'; btn.onclick=()=>{ dateInput.value=d; onDateChange(); }; historyDiv.appendChild(btn); });
}

function onDateChange(){
  const d=dateInput.value; if(!d) return;
  const copied=copyUnfinishedFromLast(d);
  if(copied) alert(copied+' t√¢che(s) non termin√©e(s) ont √©t√© report√©es pour cette date.');
  render(d);
}

document.getElementById('add').onclick=()=>{ addTask(dateInput.value||todayIso(),newTaskInput.value); newTaskInput.value=''; };
document.getElementById('clearDone').onclick=()=>{ clearDone(dateInput.value||todayIso()); };
document.getElementById('exportCsv').onclick=exportAllToCSV;

(function init(){
  const t=todayIso(); dateInput.value=t; copyUnfinishedFromLast(t); render(t);
})();
</script>
</body>
</html>
